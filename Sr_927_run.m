clc
clear all
close all

site_Number = 927;

Sr_927_main;

load('parameters_su_927.mat');
load('parameters_Ca_927.mat');

%% ============define parameters==============================
K_sr_sea = 0.194;    % Sr/Ca ratio in the solid over seawater

rho_s = 2.7;    % g/cm^3 ->g/m^3
rho_f = 1;      % g/cm^3 ->g/m^3
% 
alpha=zz(1);
beta=zz(2);
gamma=zz(3);
v=zz(4);
gra_sr = zz(5); % gradient in fluids (zero gradient in solid)
% 
% alpha=0;
% beta=0.013;
% gamma=600;
% v=0;
% gra_sr = 0.0035; % gradient in fluids (zero gradient in solid)
% 

gra_su = x927(6);
gra_ca = y927(6);

V=0;
Ks=x927(5);


t = [0;0.0192774485216781;0.0385348970433562;0.0578023455650343;0.0770697940867124;0.0963372426083905;0.115604691130069;0.134872139651747;0.154139588173425;0.173407036695103;0.192774485216781;0.211941933738459;0.231209382260137;0.250476830781815;0.269744279303493;0.289011727825172;0.308279176346850;0.327546624868528;0.346814073390206;0.366081521911884;0.385348970433562;0.404616418955240;0.423883867476918;0.443151315998596;0.462418764520275;0.481686213041953;0.500953661563631;0.520221110085309;0.539488558606987;0.558756007128665;0.578023455650343;0.597290904172021;0.616558352693699;0.635825801215377;0.655093249737055;0.674360698258733;0.693628146780411;0.712895595302089;0.732163043823767;0.751430492345446;0.770697940867124;0.789965389388802;0.809232837910480;0.828500286432158;0.847767734953836;0.867035183475514;0.886302631997192;0.905570080518870;0.924837529040548;0.944104977562226;0.963372426083904;0.982639874605582;1.00190732312726;1.02117477164894;1.04044222017062;1.05970966869229;1.07897711721397;1.09824456573565;1.11751201425733;1.13677946277901;1.15604691130069;1.17531435982236;1.19458180834404;1.21384925686572;1.23311670538740;1.25238415390908;1.27165160243075;1.29091905095243;1.31018649947411;1.32945394799579;1.34872139651747;1.36798884503915;1.38725629356082;1.40652374208250;1.42579119060418;1.44505863912586;1.46432608764754;1.48359353616921;1.50286098469089;1.52212843321257;1.54139588173425;1.56066333025593;1.57993077877761;1.59919822729928;1.61846567582096;1.63773312434264;1.65700057286432;1.67626802138600;1.69553546990767;1.71480291842935;1.73407036695103;1.75333781547271;1.77260526399439;1.79187271251607;1.81114016103774;1.83040760955942;1.84967505808110;1.86894250660278;1.88820995512446;1.90747740364613;1.92774485216781;1.94601230068949;1.96527974921117;1.98454719773285;2.00381464625452;2.02308209477620;2.04234954329788;2.06161699181956;2.08088444034124;2.10015188886292;2.11941933738459;2.13868678590627;2.15795423442795;2.17722168294963;2.19648913147131;2.21575657999298;2.23502402851466;2.25429147703634;2.27355892555802;2.29282637407970;2.31209382260138;2.33136127112305;2.35062871964473;2.36989616816641;2.38916361668809;2.40843106520977;2.42769851373144;2.44696596225312;2.46623341077480;2.48550085929648;2.50476830781816;2.52403575633984;2.54330320486151;2.56257065338319;2.58183810190487;2.60110555042655;2.62037299894823;2.63964044746990;2.65890789599158;2.67817534451326;2.69744279303494;2.71671024155662;2.73597769007830;2.75524513859997;2.77451258712165;2.79378003564333;2.81304748416501;2.83231493268669;2.85158238120836;2.87084982973004;2.89011727825172;2.90938472677340;2.92865217529508;2.94791962381676;2.96718707233843;2.98645452086011;3.00572196938179;3.02498941790347;3.04425686642515;3.06352431494682;3.08279176346850;3.10205921199018;3.12132666051186;3.14059410903354;3.15986155755521;3.17912900607689;3.19839645459857;3.21766390312025;3.23693135164193;3.25619880016361;3.27546624868528;3.29473369720696;3.31400114572864;3.33326859425032;3.35253604277200;3.37192749129367;3.39107093981535;3.41033838833703;3.42960583685871;3.44887328539279;3.46814073390207;3.48740818242374;3.50667563094542;3.52594307946710;3.54521052798878;3.56447797651046;3.58374542503213;3.60301287355381;3.62229272207549;3.64154777059717;3.66081521911885;3.68008266764053;3.69935011616220;3.71861756468388;3.73788501320556;3.75715246172724;3.77641991024892;3.79568735877059;3.81495480729227;3.83422225581395;3.85348970433563;3.87275715285731;3.89202460137899;3.91129204990066;3.93055949842234;3.94982694694402;3.96909439546570;3.98836184398738;4.00762929250905;4.02689674103073;4.04616418955241;4.06543163807409;4.08469908659577;4.10396653511744;4.12323398363912;4.14250143216080;4.16176888068248;4.18103632920415;4.20030377772583;4.21957122624751;4.23883867476919;4.25810612329086;4.27737357181254;4.29664102033422;4.31590846885590;4.33517591737758;4.35444336589925;4.37371081442093;4.39297826294261;4.41224571146429;4.43151315998596;4.45078060850764;4.47004805702932;4.48931550555100;4.50858295407268;4.52785040259435;4.54711785111603;4.56638529963771;4.58565274815939;4.60492019668106;4.62418764520274;4.64345509372442;4.66272254224610;4.68198999076777;4.70125743928945;4.72052488781113;4.73979233633281;4.75905978485449;4.77832723337616;4.79759468189784;4.81686213041952;4.83612957894120;4.85539702746287;4.87466447598455;4.89393192450623;4.91319937302791;4.93246682154959;4.95173427007126;4.97100171859294;4.99026916711462;5.00953661563630;5.02880406415797;5.04807151267965;5.06733896120133;5.08660640972301;5.10587385824468;5.12514130676636;5.14440875528804;5.16367620380972;5.18294365233140;5.20221110085307;5.22147854937475;5.24074599789643;5.26001344641811;5.27928089493978;5.29854834346146;5.31781579198314;5.33708324050482;5.35635068902649;5.37561813754817;5.39488558606985;5.41415303459153;5.43342048311321;5.45268793163488;5.47195538015656;5.49122282867824;5.51049027719992;5.52975772572159;5.54902517424327;5.56829272276495;5.58756007128663;5.60682751980831;5.62609496832998;5.64536241685166;5.66462986537334;5.68389731389502;5.70316476241669;5.72243221093837;5.74169965946005;5.76096710798173;5.78023455650340;5.79950200502508;5.81876945354676;5.83927690206844;5.85730435059012;5.87657179911179;5.89583924763347;5.91510669615515;5.93437414467683;5.95364159319850;5.97290904172018;5.99217649024186;6.01144393876354;6.03071138728522;6.04997883580689;6.06924628432857;6.08851373285025;6.10778118137193;6.12704862989360;6.14631607841528;6.16558352693696;6.18485097545864;6.20411842399271;6.22338587250199;6.24265332102367;6.26192076954535;6.28118821806703;6.30045566658870;6.31972311511038;6.33899056363206;6.35825801215374;6.37752546067541;6.39679290919709;6.41606035771877;6.43532780624045;6.45459525476213;6.47386270328380;6.49313015180548;6.51239760032716;6.53166504884884;6.55093249737051;6.57019994589219;6.58946739441387;6.60873484293555;6.62800229145722;6.64726973997890;6.66653718850058;6.68580463702226;6.70507208554394;6.72433953406561;6.74360698258729;6.76287443110897;6.78214187963065;6.80140932815232;6.82067677667400;6.83994422519568;6.85921167371736;6.87847912223903;6.89774657076071;6.91701401928239;6.93628146780407;6.95554891632575;6.97481636484742;6.99408381336910;7.01335126189078;7.03261871041246;7.05188615893413;7.07115360745581;7.09042105597749;7.10968850449917;7.12895595302085;7.14822340154252;7.16749085006420;7.18675829858588;7.20602574710756;7.22529319562923;7.24456064415091;7.26382809277259;7.28309554119427;7.30236298971594;7.32163043823762;7.34089788675930;7.36016533528098;7.37943278380266;7.39870023232433;7.41796768084601;7.43723512936769;7.45650257788937;7.47577002641104;7.49503747493272;7.51430492345440;7.53357237197608;7.55283982049776;7.57210726901943;7.59137471754111;7.61064216606279;7.62990961458447;7.64917706310614;7.66844451162782;7.68771196014950;7.70697940867118;7.72624685719285;7.74551430571453;7.76478175423621;7.78404920275789;7.92731665127957;7.82258409980124;7.84185154832292;7.86111899684460;7.89278644536628;7.89965389388795;7.91892134240963;7.93818879093131;7.95745623945299;7.97672368797467;7.99599113649634;8.01525858501802;8.03452603353970;8.05379348206138;8.07306093058305;8.09232837910473;8.11159582762641;8.13086327614809;8.15013072466977;8.16939817319144;8.18866562171312;8.20793307023480;8.22720051875648;8.24646796727815;8.26573541579983;8.28500286432151;8.30427031284319;8.32353776136486;8.34280520988654;8.36207265840822;8.38134010692990;8.40060755545158;8.41987500397325;8.43914245249493;8.45840990101661;8.47767734953829;8.49694479805996;8.51621224658164;8.53547969510332;8.55474714362500;8.57401459214668;8.59328204066835;8.61254948919003;8.63181693771171;8.65108438623339;8.67035183475506;8.68961928327674;8.70888673179842;8.72815419272010;8.74742162884177;8.76668907736345;8.78595652588513;8.80522397440681;8.82449142292849;8.84375887145016;8.86302631997184;8.88229376849352;8.90156121701520;8.92082866553687;8.94009611405855;8.95936356258023;8.97863101110191;8.99789845962359;9.01716590814526;9.03643335666694;9.05570080518862;9.07496825371030;9.09423570223197;9.11350315075365;9.13277059927533;9.15203804779701;9.17130549631868;9.19057294484036;9.20984039336204;9.22910784188372;9.24837529040540;9.26764273892707;9.28691018744875;9.30617763597043;9.32544508449211;9.34471253301378;9.36397998153546;9.38324743005714;9.40251487857882;9.42178232710050;9.44104977562217;9.46031722414385;9.47958467266553;9.49885212118721;9.51811956970888;9.53738701823056;9.55665446675224;9.57592191527392;9.59518936379559;9.61445681231727;9.63372426083895;9.65299170936063;9.67225915788231;9.69152660640398;9.71079405492566;9.73006150344734;9.74932895196902;9.76859640049069;9.78786384901237;9.80713129753405;9.82639874605573;9.84566619457740;9.86493364309908;9.88420109162076;9.90346854014244;9.92273598866412;9.94200343718579;9.96127088570747;9.98053833422915;9.99980578275083;10.0190732312725;10.0383406797942;10.0576081283159;10.0768755768375;10.0961430253592;10.1154104738809;10.1346779224026;10.1539453709242;10.1732128194459;10.1924802679676;10.2117477164893;10.2310151650110;10.2502826135326;10.2695500620543;10.2888175105760;10.3080849590977;10.3273524076193;10.3466198561410;10.3658873046627;10.3851547531844;10.4044222017061;10.4236896502277;10.4429570987494;10.4622245472711;10.4814919957928;10.5007594443144;10.5200268928361;10.5392943413578;10.5585617898795;10.5778292384012;10.5970966869228;10.6163641354445;10.6356315839662;10.6548990324879;10.6741664810095;10.6934339295312;10.7127013780529;10.7319688265746;10.7512362750963;10.7705037236179;10.7897711721396;10.8090386206613;10.8283060691830;10.8475735177046;10.8668409662263;10.8861084147480;10.9053758632697;10.9246433117914;10.9439107603130;10.9631782088347;10.9824456573564;11.0017131058781;11.0209805543997;11.0402480029214;11.0595154514431;11.0787828999648;11.0980503484865;11.1173177970081;11.1365852455298;11.1558526940515;11.1751201425732;11.1943875910948;11.2136550396165;11.2329224881382;11.2521899366599;11.2714573851816;11.2907248337032;11.3099922822249;11.3292597307466;11.3485271792783;11.3677946277899;11.3870620763116;11.4063295248333;11.4255969733550;11.4448644218767;11.4641318703983;11.4833993189200;11.5026667674417;11.5219342159634;11.5412016644850;11.5604691130067;11.5797365615284;11.5990040100501;11.6182714585718;11.6375389070934;11.6568063556151;11.6760738041368;11.6953412526585;11.7146087011801;11.7338761497018;11.7531435982235;11.7724110467452;11.7916784952669;11.8109459437885;11.8302133923102;11.8494808408319;11.8687482893536;11.8880157378752;11.9072831863969;11.9275506349186;11.9458180834403;11.9650855319620;11.9843529804836;12.0036204290053;12.0228878775270;12.0421553260487;12.0614227745703;12.0806902230920;12.0999576716137;12.1192251201354;12.1384925686571;12.1577600171787;12.1770274657004;12.1962949142221;12.2155623627438;12.2348298112654;12.2540972597871;12.2733647083088;12.2927321568305;12.3118996053522;12.3311670538738;12.3504345023955;12.3697019509172;12.3889693994389;12.4082368479605;12.4275042964822;12.4467717450039;12.4660391935256;12.4853066420473;12.5045740905689;12.5238415390906;12.5431089876123;12.5623764361340;12.5816438846556;12.6009113331773;12.6201787816990;12.6394462302207;12.6587136787424;12.6779811272640;12.6972485757857;12.7165160243074;12.7357834728291;12.7550509213507;12.7743183698724;12.7935858183941;12.8128532669158;12.8321207154375;12.8513881639591;12.8706556124808;12.8899230610025;12.9091905095242;12.9284579580458;12.9477254065675;12.9669928550892;12.9862603036109;13.0055277521326;13.0247952006542;13.0440626491759;13.0633300976976;13.0825975462193;13.1018649947409;13.1211324432626;13.1403998917843;13.1596673403060;13.1789347888277;13.1982022373493;13.2174696858710;13.2367371343927;13.2560045829144;13.2752720314360;13.2945394799577;13.3138069284794;13.3330743770011;13.3523418255228;13.3716092740444;13.3908767225661;13.4101441710878;13.4294116196095;13.4486790681311;13.4679465166528;13.4872139651745;13.5064814136962;13.5257488622179;13.5450163107395;13.5642837592712;13.5835512077829;13.6028186563046;13.6220861048262];
t_step = 0.019277448521678;
z = [0;0.500000000000000;1;1.50000000000000;2;2.50000000000000;3;3.50000000000000;4;4.50000000000000;5;5.50000000000000;6;6.50000000000000;7;7.50000000000000;8;8.50000000000000;9;9.50000000000000;10;10.5000000000000;11;11.5000000000000;12;12.5000000000000;13;13.5000000000000;14;14.5000000000000;15;15.5000000000000;16;16.5000000000000;17;17.5000000000000;17.9900000000000;18.4800000000000;18.9700000000000;19.4600000000000;19.9500000000000;20.4500000000000;20.9500000000000;21.4500000000000;21.9500000000000;22.4500000000000;22.9500000000000;23.4500000000000;23.9500000000000;24.4400000000000;24.9300000000000;25.4300000000000;25.9300000000000;26.4300000000000;26.9300000000000;27.4300000000000;27.9300000000000;28.4300000000000;28.9300000000000;29.4300000000000;29.9300000000000;30.4300000000000;30.9300000000000;31.4300000000000;31.9300000000000;32.4200000000000;32.9100000000000;33.4000000000000;33.8900000000000;34.3800000000000;34.8700000000000;35.3600000000000;35.8500000000000;36.3400000000000;36.8300000000000;37.3100000000000;37.7900000000000;38.2700000000000;38.7500000000000;39.2300000000000;39.7100000000000;40.1900000000000;40.6800000000000;41.1700000000000;41.6500000000000;42.1400000000000;42.6200000000000;43.1100000000000;43.6000000000000;44.0800000000000;44.5700000000000;45.0600000000000;45.5400000000000;46.0300000000000;46.5100000000000;47.0000000000000;47.4900000000000;47.9700000000000;48.4500000000000;48.9300000000000;49.4200000000000;49.9000000000000;50.3900000000000;50.8800000000000;51.3600000000000;51.8500000000000;52.3300000000000;52.8200000000000;53.3100000000000;53.7900000000000;54.2800000000000;54.7600000000000;55.2500000000000;55.7400000000000;56.2200000000000;56.7100000000000;57.1900000000000;57.6800000000000;58.1500000000000;58.6300000000000;59.1000000000000;59.5700000000000;60.0400000000000;60.5100000000000;60.9800000000000;61.4500000000000;61.9200000000000;62.3900000000000;62.8600000000000;63.3300000000000;63.8000000000000;64.2700000000000;64.7400000000000;65.2200000000000;65.6900000000000;66.1600000000000;66.6300000000000;67.1000000000000;67.5800000000000;68.0500000000000;68.5200000000000;68.9900000000000;69.4700000000000;69.9400000000000;70.4100000000000;70.8800000000000;71.3600000000000;71.8300000000000;72.3000000000000;72.7700000000000;73.2400000000000;73.7200000000000;74.1900000000000;74.6600000000000;75.1300000000000;75.6100000000000;76.0800000000000;76.5500000000000;77.0200000000000;77.4900000000000;77.9700000000000;78.4400000000000;78.9100000000000;79.3800000000000;79.8600000000000;80.3300000000000;80.8000000000000;81.2700000000000;81.7400000000000;82.2100000000000;82.6600000000000;83.1300000000000;83.6000000000000;84.0500000000000;84.5200000000000;84.9900000000000;85.4600000000000;85.9100000000000;86.3800000000000;86.8500000000000;87.3000000000000;87.7700000000000;88.2400000000000;88.7100000000000;89.1600000000000;89.6300000000000;90.1000000000000;90.5500000000000;91.0200000000000;91.4900000000000;91.9600000000000;92.4100000000000;92.8800000000000;93.3500000000000;93.8000000000000;94.2700000000000;94.7400000000000;95.2100000000000;95.6600000000000;96.1200000000000;96.5800000000000;97.0500000000000;97.5200000000000;97.9900000000000;98.4400000000000;98.9100000000000;99.3800000000000;99.8500000000000;100.300000000000;100.770000000000;101.240000000000;101.690000000000;102.160000000000;102.630000000000;103.100000000000;103.550000000000;104.020000000000;104.490000000000;104.940000000000;105.410000000000;105.860000000000;106.310000000000;106.760000000000;107.210000000000;107.660000000000;108.110000000000;108.560000000000;109.010000000000;109.460000000000;109.910000000000;110.360000000000;110.810000000000;111.260000000000;111.710000000000;112.160000000000;112.610000000000;113.060000000000;113.510000000000;113.960000000000;114.410000000000;114.860000000000;115.310000000000;115.760000000000;116.210000000000;116.660000000000;117.110000000000;117.560000000000;118.010000000000;118.460000000000;118.910000000000;119.360000000000;119.810000000000;120.260000000000;120.710000000000;121.160000000000;121.610000000000;122.060000000000;122.510000000000;122.960000000000;123.410000000000;123.860000000000;124.310000000000;124.760000000000;125.210000000000;125.660000000000;126.110000000000;126.560000000000;127.010000000000;127.460000000000;127.910000000000;128.360000000000;128.810000000000;129.260000000000;129.710000000000;130.160000000000;130.610000000000;131.060000000000;131.510000000000;131.960000000000;132.410000000000;132.860000000000;133.300000000000;133.740000000000;134.180000000000;134.620000000000;135.060000000000;135.500000000000;135.940000000000;136.380000000000;136.820000000000;137.260000000000;137.700000000000;138.140000000000;138.580000000000;139.020000000000;139.460000000000;139.900000000000;140.340000000000;140.780000000000;141.220000000000;141.660000000000;142.100000000000;142.540000000000;142.980000000000;143.430000000000;143.870000000000;144.310000000000;144.750000000000;145.190000000000;145.630000000000;146.070000000000;146.510000000000;146.950000000000;147.390000000000;147.830000000000;148.270000000000;148.710000000000;149.150000000000;149.590000000000;150.030000000000;150.470000000000;150.910000000000;151.350000000000;151.790000000000;152.230000000000;152.670000000000;153.110000000000;153.550000000000;153.990000000000;154.430000000000;154.870000000000;155.310000000000;155.750000000000;156.190000000000;156.630000000000;157.070000000000;157.510000000000;157.950000000000;158.390000000000;158.830000000000;159.270000000000;159.710000000000;160.150000000000;160.590000000000;161.030000000000;161.470000000000;161.910000000000;162.350000000000;162.790000000000;163.230000000000;163.660000000000;164.090000000000;164.520000000000;164.950000000000;165.380000000000;165.810000000000;166.240000000000;166.670000000000;167.100000000000;167.530000000000;167.960000000000;168.390000000000;168.820000000000;169.250000000000;169.680000000000;170.110000000000;170.540000000000;170.970000000000;171.400000000000;171.830000000000;172.260000000000;172.690000000000;173.120000000000;173.550000000000;173.980000000000;174.410000000000;174.840000000000;175.270000000000;175.700000000000;176.130000000000;176.560000000000;176.990000000000;177.420000000000;177.850000000000;178.280000000000;178.710000000000;179.140000000000;179.570000000000;180.000000000000;180.430000000000;180.860000000000;181.290000000000;181.720000000000;182.150000000000;182.580000000000;183.010000000000;183.440000000000;183.870000000000;184.300000000000;184.730000000000;185.160000000000;185.590000000000;186.020000000000;186.450000000000;186.880000000000;187.310000000000;187.740000000000;188.170000000000;188.600000000000;189.030000000000;189.460000000000;189.890000000000;190.320000000000;190.750000000000;191.180000000000;191.610000000000;192.040000000000;192.470000000000;192.900000000000;193.330000000000;193.760000000000;194.190000000000;194.620000000000;195.050000000000;195.480000000000;195.910000000000;196.340000000000;196.770000000000;197.200000000000;197.620000000000;198.040000000000;198.460000000000;198.880000000000;199.300000000000;199.720000000000;200.140000000000;200.560000000000;200.980000000000;201.400000000000;201.820000000000;202.240000000000;202.660000000000;203.080000000000;203.500000000000;203.920000000000;204.340000000000;204.760000000000;205.180000000000;205.600000000000;206.020000000000;206.440000000000;206.860000000000;207.280000000000;207.700000000000;208.120000000000;208.540000000000;208.960000000000;209.380000000000;209.800000000000;210.220000000000;210.640000000000;211.060000000000;211.480000000000;211.900000000000;212.320000000000;212.750000000000;213.180000000000;213.600000000000;214.030000000000;214.460000000000;214.880000000000;215.310000000000;215.740000000000;216.160000000000;216.590000000000;217.010000000000;217.440000000000;217.870000000000;218.290000000000;218.720000000000;219.150000000000;219.570000000000;220.000000000000;220.430000000000;220.850000000000;221.280000000000;221.710000000000;222.130000000000;222.560000000000;222.990000000000;223.410000000000;223.840000000000;224.260000000000;224.690000000000;225.120000000000;225.540000000000;225.970000000000;226.400000000000;226.820000000000;227.250000000000;227.680000000000;228.100000000000;228.530000000000;228.960000000000;229.380000000000;229.810000000000;230.240000000000;230.660000000000;231.090000000000;231.510000000000;231.940000000000;232.370000000000;232.790000000000;233.220000000000;233.650000000000;234.070000000000;234.500000000000;234.930000000000;235.350000000000;235.760000000000;236.180000000000;236.590000000000;237.000000000000;237.410000000000;237.820000000000;238.230000000000;238.640000000000;239.050000000000;239.460000000000;239.870000000000;240.280000000000;240.690000000000;241.100000000000;241.510000000000;241.920000000000;242.330000000000;242.740000000000;243.150000000000;243.560000000000;243.970000000000;244.380000000000;244.790000000000;245.200000000000;245.610000000000;246.020000000000;246.430000000000;246.840000000000;247.250000000000;247.660000000000;248.070000000000;248.480000000000;248.890000000000;249.300000000000;249.710000000000;250.120000000000;250.530000000000;250.940000000000;251.350000000000;251.760000000000;252.170000000000;252.580000000000;252.990000000000;253.400000000000;253.810000000000;254.220000000000;254.630000000000;255.040000000000;255.450000000000;255.860000000000;256.270000000000;256.680000000000;257.090000000000;257.500000000000;257.910000000000;258.320000000000;258.730000000000;259.140000000000;259.550000000000;259.960000000000;260.370000000000;260.780000000000;261.190000000000;261.600000000000;262.010000000000;262.420000000000;262.830000000000;263.240000000000;263.650000000000;264.060000000000;264.470000000000;264.880000000000;265.290000000000;265.700000000000;266.110000000000;266.520000000000;266.930000000000;267.340000000000;267.750000000000;268.160000000001;268.570000000001;268.980000000001;269.390000000001;269.800000000001;270.210000000001;270.620000000001;271.030000000001;271.440000000001;271.850000000001;272.260000000001;272.670000000001;273.080000000001;273.490000000001;273.900000000001;274.310000000001;274.720000000001;275.130000000001;275.540000000001;275.950000000001;276.360000000001;276.770000000001;277.180000000001;277.590000000001;278.000000000001;278.410000000001;278.810000000001;279.210000000001;279.610000000001;280.010000000001;280.410000000001;280.810000000001;281.210000000001;281.610000000001;282.010000000001;282.410000000001;282.810000000001;283.210000000001;283.610000000001;284.010000000001;284.410000000001;284.810000000001;285.210000000001;285.610000000001;286.010000000001;286.410000000001;286.810000000001;287.210000000001;287.610000000001;288.010000000001;288.410000000001;288.810000000001;289.210000000001;289.610000000000;290.010000000000;290.410000000000;290.810000000000;291.210000000000;291.610000000000;292.010000000000;292.410000000000;292.810000000000;293.210000000000;293.610000000000;294.010000000000;294.410000000000;294.810000000000;295.210000000000;295.610000000000;296.010000000000;296.410000000000;296.810000000000;297.210000000000;297.610000000000;298.010000000000;298.410000000000;298.810000000000;299.210000000000;299.610000000000;300.010000000000;300.420000000000;300.820000000000;301.230000000000;301.630000000000;302.040000000000;302.440000000000;302.850000000000;303.250000000000;303.660000000000;304.060000000000;304.460000000000;304.870000000000;305.270000000000;305.680000000000;306.080000000000;306.490000000000;306.890000000000;307.300000000000;307.700000000000;308.110000000000;308.510000000000;308.920000000000;309.320000000000;309.730000000000;310.130000000000;310.540000000000;310.940000000000;311.350000000000;311.750000000000;312.160000000000];
z_step = [0;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.490000000000000;0.490000000000000;0.490000000000000;0.490000000000000;0.490000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.490000000000000;0.490000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.500000000000000;0.490000000000000;0.490000000000000;0.490000000000000;0.490000000000000;0.490000000000000;0.490000000000000;0.490000000000000;0.490000000000000;0.490000000000000;0.490000000000000;0.480000000000000;0.480000000000000;0.480000000000000;0.480000000000000;0.480000000000000;0.480000000000000;0.480000000000000;0.490000000000000;0.490000000000000;0.480000000000000;0.490000000000000;0.480000000000000;0.490000000000000;0.490000000000000;0.480000000000000;0.490000000000000;0.490000000000000;0.480000000000000;0.490000000000000;0.480000000000000;0.490000000000000;0.490000000000000;0.480000000000000;0.480000000000000;0.480000000000000;0.490000000000000;0.480000000000000;0.490000000000000;0.490000000000000;0.480000000000000;0.490000000000000;0.480000000000000;0.490000000000000;0.490000000000000;0.480000000000000;0.490000000000000;0.480000000000000;0.490000000000000;0.490000000000000;0.480000000000000;0.490000000000000;0.480000000000000;0.490000000000000;0.470000000000000;0.480000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.480000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.480000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.480000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.480000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.480000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.480000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.480000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.480000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.460000000000000;0.460000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.470000000000000;0.450000000000000;0.470000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.450000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.450000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.440000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.430000000000000;0.430000000000000;0.420000000000000;0.410000000000000;0.420000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.410000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000;0.400000000000000;0.410000000000000];

%------- initialize the paramter------
J = length(z);
N = J;


f_a = 0;
f_b = 67.142/100;
f_c = 1/9E-04;
phi_z = f_a + f_b*exp(-z/f_c);  % porosity over depth
fc = 58/100 ; 

R_d = zeros(N,J);
R_net = zeros(N,J);
R_p = zeros(N,J);

for n = 1:N
    for j = 1:n
        R_net(n,j) = y927(2)+y927(3)*exp(-z(n-j+1)/y927(4));
    end
end


temp_T = 0.0275 * z + 3.1556 + 273.15;

K_sr = zeros(length(z),1);

for i = 1:length(z)
    %     K_sr(i) = exp(-4.38 + 1.71e3/temp_T(i)-4.22e5/temp_T(i)^2)-0.006;
    K_sr(i)=0.025;
end

D0 = zeros(length(z),1);
D = zeros(length(z),1);

for i = 1:length(z)
    D0(i) = (3.69+ 0.169 * (temp_T(i)-273.15)) * 3.65 * 24 * 36;
    D(i) = D0(i) / (1-log(phi_z(i)^2));
end

D_so4=1.53*D;

L = 0.5;
k_su = x927(3);
G0 = x927(2);  %[mM/1 porewater]  by fitting

% K_sp is from fitting data, fitting celestite
K_sp = zeros(J,1);
for i = 1 :J
    K_sp(i) = -0.003557 * z(i) + 20.73+0.5;
end


for n = 1:N
    for j = 1:n
        R_d (n,j) = alpha+beta*exp(-z(n-j+1)/gamma);
        R_p(n,j) = R_d(n,j) - R_net(n,j);
    end
end

%% =============read data====================

%read data
[Leg1,Site1,Topcm1,Botcm,Depthmbsf1,CalciumCamM,ChlorinityClmM,MagnesiumMgmM,pHpHna,SodiumNamM,StrontiumSruM,SulfateSO4mM,SilicaH4SiO4uM,AlkalinityALKmM,SalinitySALna] = importfile_water('water.xlsx');
index=(Site1==site_Number);
depth=Depthmbsf1(index);
Sr=StrontiumSruM(index);

depth2=Depthmbsf1(index);
Ca2_data=CalciumCamM(index);

[site_sr,depth_sr,age_sr,SrCaRatio_Solid] = importfile_Solid_Sr('SrCaSolid.xlsx');

indexsr=(site_sr==site_Number);
depth1=depth_sr(indexsr);
Solid_Sr=SrCaRatio_Solid(indexsr)*10; % convert m mole/mole to mM of solid Sr
Solid_Sr_T = transpose(interp1(depth1,Solid_Sr,z,'linear','extrap'));   % interpolate and extrapolate the Sr-depth data with Linear method

%% ==========Ca calculation and best fit===========

Ca_pore = zeros(N,J);        % Ca profile over space and time
Ca_sea = zeros(N,1);

for n = 1: N
    Ca_sea(n) = 10.62+0.161*t(n);
end

for n =1:N
    Ca_pore(n,n:n+1) = 10.62 + 0.161*t(N-n+1);
end

Ca_pore(2,1) = Ca_pore(2,2)+ z_step(2)* gra_ca;

for n = 2: N-1
    
    a10 = 2*D(n-2+1)*t_step/z_step(n-2+2)^2;
    b10 = t_step*v/z_step(n-2+2);
    
    Ca_pore(n+1,2) = ((a10-b10)*Ca_pore(n,2+1) + (a10+b10)*(Ca_pore(n, 3) + 2 * z_step(n)* gra_ca) + (1-a10)*Ca_pore(n-1,2) + 2*10*1000 * t_step * R_net(n-2+1) *fc* rho_s / rho_f * (1-phi_z(n-2+2)) / phi_z(n-2+2)) / (1+a10);
    
    for j = 3:n
        
        a1 = 2*D(n-j+1)*t_step/z_step(n-j+2)^2;
        b1 = t_step*v/z_step(n-j+2);
        
        Ca_pore(n+1,j) = ((a1-b1)*Ca_pore(n,j+1) + (a1+b1)*Ca_pore(n,j-1) + (1-a1)*Ca_pore(n-1,j) + 2*10*1000 * t_step * R_net(n-j+1) *fc* rho_s / rho_f * (1-phi_z(n-j+2)) / phi_z(n-j+2)) / (1+a1);
        
    end

end

Ca_pore(:,1)=Ca_pore(:,2);

k = zeros(N,J);     % Sr/Sr2+ coefficient between solid and pore water

for n = 1:N
    for j = 1: n
        k(n,j) = K_sr(n-j+1) * 10 / Ca_pore(n,j) *1000;
    end
end

%% =========== Sulfate reduction model ==========

G= zeros(N,J);
G(:,1) = G0;
G(1,2) = G0;

for i = 1:N
    G(i,i:i+1) = G0;
end

C_su=zeros(N,J);

%---------boundary condition of sulfate in the pore water---------
Sea_sulfate=zeros(N,1);
for i = 1: N
    Sea_sulfate(i) = -0.15 * t(i) + 28;
end

for i = 1:N
    C_su(i,i:i+1) = Sea_sulfate(N-i+1);      % initial value of sulfate in the pore water
end

C_su(:,1) = Sea_sulfate(end);

%% ============ Sr and Sulfate calculation ===========

C_s = zeros(N, J); % in solid (ppm)
C_f = zeros(N, J); % in pore fluid (ppm)


% -----------Initial / Boundary Conditions-----------------

seawater927 = ones(1,N);
solid0 = zeros(1,N);

for i = 1:N
    seawater927(i) = Ca_sea(i)*Solid_Sr_T(i)/10000/K_sr_sea;  % ppm -> mM
    solid0(i) = Solid_Sr_T(i);
end


K = zeros(N,1);     % Sr/Sr2+ coefficient between solid and seawater

for n = 1:N
    K(n) = K_sr_sea / Ca_sea(n)*10000;
end

% assume the initial condition of seawater


for i = 1:N
    C_s(i,i:i+1) = solid0(N-i+1);  %initial value at the lastest deposit carbonate solid
end
C_s(1,2) = solid0(N);

for i = 1:N
    C_f(i, i:i+1) = seawater927(N-i+1);  %initial value at the lastest pore water
end

C_f(2,1) = C_f(2,2)+z_step(2)* gra_sr;

% -----Calculate the first concentration in solid and pore water-

for n = 2:N-1
    
    a10 = 2*D(n-2+1)*t_step/z_step(n-2+2)^2;
    a10_so4 = 2*D_so4(n-2+1)*t_step/z_step(n-2+2)^2;
    b10 = t_step*v/z_step(n-2+2);
    b20 = 2*V*t_step/z_step(n-2+2);
    
    a20 = 2*t_step*R_p(n-1,2)*rho_s/rho_f*(1-phi_z(n-2+2))/phi_z(n-2+2);  % attention the z(2) always represent the bottom
    a30 = R_d(n-1,2)*2*t_step;
    
    %     C_f(n,2-1) = C_f(n,2+1)+ 2*z_step(n)* gra_sr;
    %     C_su(n, 2-1) = C_su(n, 2+1)+ 2 * z_step(n)* gra_su;
    
    C_f(n+1,2) = (a10*C_f(n,2+1)+a10*C_f(n,2-1) + (1-a10-a20*k(n-1,2))*C_f(n-1,2) + 2*t_step*R_d(n-1,2)*rho_s/rho_f*(1-phi_z(n-2+2))/phi_z(n-2+2)*C_s(n-1,2)) / (1+a10);
    C_s(n+1,2) = (1-a30)*C_s(n-1,2) + R_p(n-1,2)*2*t_step*k(n-1,2)*C_f(n-1,2);
    
    C_su(n+1,2) = ((a10_so4-b10)*C_su(n,2+1)+(a10_so4+b10)*(C_su(n, 3)+ 2 * z_step(n)* gra_su)+(1-a10_so4)*C_su(n-1,2)-2*t_step*k_su*L*G(n-1,2)*C_su(n-1,2)/(C_su(n-1,2)+Ks))/(1+a10_so4);
    G(n+1,2) = G(n-1,2) * (1 - 2*k_su*t_step*C_su(n-1,2)/(Ks +C_su(n-1,2)));
    
    if C_su(n+1,2) < 0
        C_su(n+1,2) = 0;
    end
    
    for j = 3:n
        
        a1 = 2*D(n-j+1)*t_step/z_step(n-j+2)^2;
        a1_so4 = 2*D_so4(n-j+1)*t_step/z_step(n-j+2)^2;
        b1 = t_step*v/z_step(n-j+2);
        b2 = 2*V*t_step/z_step(n-j+2);
        
        a2 = 2*t_step*R_p(n-1,j)*rho_s/rho_f*(1-phi_z(n-j+2))/phi_z(n-j+2);  % attention the z(2) always represent the bottom
        a3 = R_d(n-1,j)*2*t_step;
        
        C_f(n+1,j) = (a1*C_f(n,j+1)+a1*C_f(n,j-1) + (1-a1-a2*k(n-1,j))*C_f(n-1,j) + 2*t_step*R_d(n-1,j)*rho_s/rho_f*(1-phi_z(n-j+2))/phi_z(n-j+2)*C_s(n-1,j)) / (1+a1);
        C_s(n+1,j) = (1-a3)*C_s(n-1,j) + R_p(n-1,j)*2*t_step*k(n-1,j)*C_f(n-1,j);
        
        C_su(n+1,j) = ((a1_so4-b1)*C_su(n,j+1)+(a1_so4+b1)*C_su(n,j-1)+(1-a1_so4)*C_su(n-1,j)-2*t_step*k_su*L*G(n-1,j)*C_su(n-1,j)/(C_su(n-1,j)+Ks))/(1+a1_so4);
        G(n+1,j) = G(n-1,j) * (1 - 2*k_su*t_step*C_su(n-1,j)/(Ks +C_su(n-1,j))) - b2 * G(n,j+1) + b2 * G(n,j-1);
        
        if C_su(n+1,j) < 0
            C_su(n+1,j) = 0;
        end
        % judge the precipitation of SrSO4
        
%         if C_su(n+1,j) * C_f(n+1,j)  >=  K_sp(n+1-j+1)
%             C_f(n+1,j) = K_sp(n+1-j+1)/C_su(n+1,j);
%         end
    end
    
    C_f(n+1,1) = C_f(n+1,3) + 2*z_step(n+1)* gra_sr;
    C_s(n+1,1) = C_s(n+1,3);
    C_su(n+1,1) = C_su(n+1,3) + 2*z_step(n+1)* gra_su;
    
end

%% =========== simulate the best fit of seawater ==============
number_loops = 2;
Dif=zeros(1,J);
for p = 1:number_loops
    for pp = 1:J
        Dif(pp) = (Solid_Sr_T(pp) - C_s(N,J-pp+1))/K(pp);
    end
    seawater927 = seawater927 + Dif;
    
    
    %re-initialize
    
    G= zeros(N,J);
    G(:,1) = G0;
    G(1,2) = G0;
    
    for i = 1:N
        G(i,i:i+1) = G0;
    end
    
    C_su=zeros(N,J);
    
    %---------boundary condition of sulfate in the pore water---------
    Sea_sulfate=zeros(N,1);
    for i = 1: N
        Sea_sulfate(i) = -0.15 * t(i) + 28;
    end
    
    for i = 1:N
        C_su(i,i:i+1) = Sea_sulfate(N-i+1);      % initial value of sulfate in the pore water
    end
    
    C_su(:,1) = Sea_sulfate(end);
    
    C_s = zeros(N, J); % in solid (ppm)
    C_f = zeros(N, J); % in pore fluid (ppm)
    
    
    %end re-initialize
    
    
    K = zeros(N,1);     % Sr/Sr2+ coefficient between solid and seawater
    
    for n = 1:N
        K(n) = K_sr_sea / Ca_sea(n)*10000;
    end
    
    for i = 1:N
        solid0(i) = K (i) * seawater927(i);
    end
    
    for i = 1:N
        C_s(i,i:i+1) = solid0(N-i+1);  %initial value in solid
    end
    C_s(1,2)=solid0(N);
    
    for i = 1:N
        C_f(i, i:i+1) = seawater927(N-i+1);  %initial value at the lastest pore water
    end
    
    C_f(2,1) = C_f(2,2)+z_step(2)* gra_sr;
    
    for n = 2:N-1
        
        a10 = 2*D(n-2+1)*t_step/z_step(n-2+2)^2;
        a10_so4 = 2*D_so4(n-2+1)*t_step/z_step(n-2+2)^2;
        b10 = t_step*v/z_step(n-2+2);
        b20 = 2*V*t_step/z_step(n-2+2);
        
        a20 = 2*t_step*R_p(n-1,2)*rho_s/rho_f*(1-phi_z(n-2+2))/phi_z(n-2+2);  % attention the z(2) always represent the bottom
        a30 = R_d(n-1,2)*2*t_step;
        
        %         C_f(n,2-1) = C_f(n,2+1)+ 2*z_step(n)* gra_sr;
        %         C_su(n, 2-1) = C_su(n, 2+1)+ 2 * z_step(n)* gra_su;
        
        C_f(n+1,2) = (a10*C_f(n,2+1)+a10*C_f(n,2-1) + (1-a10-a20*k(n-1,2))*C_f(n-1,2) + 2*t_step*R_d(n-1,2)*rho_s/rho_f*(1-phi_z(n-2+2))/phi_z(n-2+2)*C_s(n-1,2)) / (1+a10);
        C_s(n+1,2) = (1-a30)*C_s(n-1,2) + R_p(n-1,2)*2*t_step*k(n-1,2)*C_f(n-1,2);
        
        C_su(n+1,2) = ((a10_so4-b10)*C_su(n,2+1)+(a10_so4+b10)*(C_su(n, 3)+ 2 * z_step(n)* gra_su)+(1-a10_so4)*C_su(n-1,2)-2*t_step*k_su*L*G(n-1,2)*C_su(n-1,2)/(C_su(n-1,2)+Ks))/(1+a10_so4);
        G(n+1,2) = G(n-1,2) * (1 - 2*k_su*t_step*C_su(n-1,2)/(Ks +C_su(n-1,2)));
        
        if C_su(n+1,2) < 0
            C_su(n+1,2) = 0;
        end
        
        for j = 3:n
            
            a1 = 2*D(n-j+1)*t_step/z_step(n-j+2)^2;
            a1_so4 = 2*D_so4(n-j+1)*t_step/z_step(n-j+2)^2;
            b1 = t_step*v/z_step(n-j+2);
            b2 = 2*V*t_step/z_step(n-j+2);
            
            a2 = 2*t_step*R_p(n-1,j)*rho_s/rho_f*(1-phi_z(n-j+2))/phi_z(n-j+2);  % attention the z(2) always represent the bottom
            a3 = R_d(n-1,j)*2*t_step;
            
            C_f(n+1,j) = (a1*C_f(n,j+1)+a1*C_f(n,j-1) + (1-a1-a2*k(n-1,j))*C_f(n-1,j) + 2*t_step*R_d(n-1,j)*rho_s/rho_f*(1-phi_z(n-j+2))/phi_z(n-j+2)*C_s(n-1,j)) / (1+a1);
            C_s(n+1,j) = (1-a3)*C_s(n-1,j) + R_p(n-1,j)*2*t_step*k(n-1,j)*C_f(n-1,j);
            
            C_su(n+1,j) = ((a1_so4-b1)*C_su(n,j+1)+(a1_so4+b1)*C_su(n,j-1)+(1-a1_so4)*C_su(n-1,j)-2*t_step*k_su*L*G(n-1,j)*C_su(n-1,j)/(C_su(n-1,j)+Ks))/(1+a1_so4);
            G(n+1,j) = G(n-1,j) * (1 - 2*k_su*t_step*C_su(n-1,j)/(Ks +C_su(n-1,j))) - b2 * G(n,j+1) + b2 * G(n,j-1);
            
            if C_su(n+1,j) < 0
                C_su(n+1,j) = 0;
            end
            % judge the precipitation of SrSO4
            
%             if C_su(n+1,j) * C_f(n+1,j)  >=  K_sp(n+1-j+1)
%                 C_f(n+1,j) = K_sp(n+1-j+1)/C_su(n+1,j);
%             end
        end
        
        C_f(n+1,1) = C_f(n+1,3) + 2*z_step(n+1)* gra_sr;
        C_s(n+1,1) = C_s(n+1,3);
        C_su(n+1,1) = C_su(n+1,3) + 2*z_step(n+1)* gra_su;
        
    end
    
    
end


%% ------- Chemical Porosity Calculation ----------
phi_che = zeros(length(t),length(z));    % Chemcial Porosity
for n = 1:length(t)
    for j = 1:n
        phi_che(n,j) = phi_z(n-j+1) - (1 - (1 - phi_z(n-j+1)) * (1 - 0 * R_net(n,j) * t_step) / (1 - R_d(n,j) * t_step));
    end
end

phi_test =  sum(phi_che,1);
phi_che_plot = phi_z(1)*ones(length(z),1) - transpose(phi_test);

%% ------------------- plot figures ---------------
t_total = t(end);
t1 = round((t_total - 10)/t_step);
t2 = round((t_total - 7)/t_step);
t3 = round((t_total - 3)/t_step);

figure
plot(fliplr(C_f(N,2:J)),z(2:J),'linewidth',2);
set(gca,'Ydir','reverse');  %reverse depth axis
hold on
plot(fliplr(C_f(N-t1,1:J-t1)),z(1+t1:end),'--','linewidth',2)
plot(fliplr(C_f(N-t2,1:J-t2)),z(1+t2:end),':','linewidth',2)
plot(fliplr(C_f(N-t3,1:J-t3)),z(1+t3:end),'-.','linewidth',2)

scatter(Sr/1000,depth,'ko')      % convert from muM to mM
title('Site 927');
xlabel('Sr in pore water (mM)');
ylabel('Present-day depth (m)')
set(gca,'FontSize',12)
legend('t=13.6 m.y.','t=10 m.y.','t=7 m.y.','t=3 m.y.','Sr^{2+} Data','location','SouthWest')
print('Sr927.jpg','-djpeg','-r600');

%--------
figure;
plot(fliplr(C_s(N,2:J))/10,z(2:J),'linewidth',2);
set(gca,'Ydir','reverse');  %reverse depth axis
hold on
scatter(Solid_Sr/10,depth1,'ko')

plot(solid0(1:end-2)/10,z(1:end-2),'--','linewidth',2);

title('Site 927');
xlabel('Sr/Ca in solid carbonate (mM/M)');
ylabel('Present-day depth (m)')
set(gca,'FontSize',12)
legend('Sr/Ca after diagenesis','Sr/Ca measured','Sr/Ca in depositional solid','location','NorthWest');
print('solid927.jpg','-djpeg','-r600');

%--------
figure;
seawater_ca = zeros(N,1);
for i = 1:N
    seawater_ca (i) = seawater927(i)/Ca_sea(i);
end
plot(t(1:end-2),seawater_ca(1:end-2)*1000,'linewidth',2)      %convect Sr/Ca mM/mM to uM/mM

% seawater data from paper (Coggon 2010, green line)
Time00=[0.821917808000000;3.01369863000000;6.02739726000000;8.76712328800000;11.5068493200000;13.6986301400000;19.7260274000000;25.2054794500000;29.8630137000000;32.6027397300000;34.7945205500000;37.5342465800000;41.0958904100000;44.3835616400000;47.9452054800000;50.6849315100000;52.8767123300000;55.0684931500000;57.2602739700000;61.3698630100000];
seawater_ca_data=[9.03943412500000;9.20790650400000;8.37112027000000;8.37221353700000;8.65263641200000;8.65351102600000;8.37658660300000;8.15530944900000;8.04543615900000;7.82306573800000;7.71220850800000;7.65743585300000;7.54712525600000;7.66016901900000;7.82918927100000;7.77441537600000;7.66355814500000;7.94376236800000;8.50329619900000;8.72839978600000];
seawater00=seawater_ca_data*1.03/100;    % convect Sr/Ca mMol/Mol to mM Sr in seawater

hold on
scatter(Time00,seawater_ca_data,'ko')

title('Sr/Ca in seawater vs time (m.y.)');
xlabel('Time (m.y.)');
ylabel('Sr/Ca (\muM/mM) in seawater')
set(gca,'FontSize',12)

% pick sample to output

data_index=[];  % sample index
for ii = 1:length(depth1)
    
    for jj = 1:(length(z)-1)
        
        if z (jj) <= depth1 (ii) && z (jj+1) > depth1 (ii)
            data_index = [data_index,jj];
        end
    end
end

% data output corresponds to the collected solid samples
t_output = t(data_index);
seawater_output = seawater927(data_index);

seawater_ca_output =seawater_ca(data_index);

scatter(t_output,seawater_ca_output*1000,'r*')

legend('Simulated Sr/Ca','Data collected from foraminifera','Selected output from simulation')

%---------
figure;
plot(fliplr(C_su(N,1:J)),z(1:N),'linewidth',2)
hold on
plot(fliplr(C_su(N-t1,1:J-t1)),z(1+t1:end),'--','linewidth',2)
plot(fliplr(C_su(N-t2,1:J-t2)),z(1+t2:end),':','linewidth',2)
plot(fliplr(C_su(N-t3,1:J-t3)),z(1+t3:end),'-.','linewidth',2)
set(gca,'Ydir','reverse')
xlabel('[SO_4]_f (mM)');
ylabel('Depth (m)')
set(gca,'FontSize',12)

index3=(Site1==site_Number & SulfateSO4mM >0);
depth3=Depthmbsf1(index3);
sulfate_data=SulfateSO4mM(index3);

scatter(sulfate_data,depth3,'ko')
legend('t=13.6 m.y.','t=10 m.y.','t=7 m.y.','t=3 m.y.','Sulfate Data')
print('sulfate927.jpg','-djpeg','-r600');

% ---------
figure
plot(fliplr(Ca_pore(N,1:J)),z,'linewidth',2)
hold on
plot(fliplr(Ca_pore(N-t1,1:J-t1)),z(1+t1:end),'--','linewidth',2)
plot(fliplr(Ca_pore(N-t2,1:J-t2)),z(1+t2:end),':','linewidth',2)
plot(fliplr(Ca_pore(N-t3,1:J-t3)),z(1+t3:end),'-.','linewidth',2)

set(gca,'Ydir','reverse')
scatter (Ca2_data,depth2,'ko');
xlabel('[Ca]_f (mM)');
ylabel('Depth (m)')
set(gca,'FontSize',12)

legend('t=13.6 m.y.','t=10 m.y.','t=7 m.y.','t=3 m.y.','Calcium Data')
print('calcium927.jpg','-djpeg','-r600');

% --------

figure;
plot(phi_z,z,'linewidth',2);
hold on
plot(flipud(phi_che_plot),z,'--','linewidth',2)
plot(phi_z(1)*ones(length(z),1),z,':','linewidth',2)
set(gca,'Ydir','reverse')
title('Site 927')
xlabel('Porosity');
ylabel('Present-day depth (m)')
legend('Final porosity','Porosity after chemical compaction','Initial depositional porosity','location','NorthWest')
set(gca,'FontSize',12)

% -------

% mul_res = zeros(N,J);
% for n = 1: N
%     for i = 1:J
%         mul_res (n,i) = C_su(n,i) * C_f(n,i);
%     end
% end
% figure
% plot(mul_res(N,:),z(end)-z(1:J),'b');
% set(gca,'Ydir','reverse')
% hold on
% plot(mul_res(N-81,1:J-81),z(end)-z(1+81:J),'r');
% plot(mul_res(N-165,1:J-165),z(end)-z(1+165:J),'g');
% plot(mul_res(N-248,1:J-248),z(end)-z(1+248:J),'m');
% plot(K_sp,z)
% legend('t=39.8 m.y.','t=35 m.y.','t=30 m.y.','t=25 m.y.')

%% ---- fraction of recrystallized calcite------

figure;
Rec_fra = fliplr(sum(R_d)*t_step*100); % in percentage (%)
plot(Rec_fra,z,'linewidth',2);
set(gca,'Ydir','reverse');  %reverse depth axis

xlabel('Fraction of recrystallized calcite (%)')
ylabel('Present-day depth (m)');
title('Site 927')
set(gca,'FontSize',12)


Ksr927=fliplr(C_s(N,1:J))/10.*fliplr(Ca_pore(N,1:J))./fliplr(C_f(N,1:J))/1000

figure;
plot(Ksr927,z,'LineWidth',2);

set(gca,'Ydir','reverse');  %reverse depth axis
hold on
title('Site 927');
xlabel('[Sr/Ca]_s/[Sr/Ca]_f');
ylabel('Present-day depth (m)');
print('Ksr927.jpg','-djpeg','-r600');

newName = 'Sr927';
S.(newName) = seawater_ca_output;

newName = 't927';
S.(newName) = t_output;

newName = 'Re927';
S.(newName) = Rec_fra;

newName = 'z927';
S.(newName) = z;

newName = 'Rnet927';
S.(newName) = fliplr(R_net(N,:));

newName = 'Rd927';
S.(newName) = fliplr(R_d(N,:));

newName = 'Ksr927';
S.(newName) = Ksr927;

save('data927.mat', '-struct', 'S'); 

save('seawater927.mat','seawater927');

newName = 'fitSr_no_celestite_Ksr2';
S.(newName) = fliplr(C_f(N,1:J));
save('parameters_sr_no_celestite_927_Ksr2.mat', '-struct', 'S'); 